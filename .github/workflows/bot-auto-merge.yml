name: "Bot: Auto-Merge"

on:
  pull_request:
    types: [labeled, closed]

jobs:
  auto-merge:
    # Nur wenn ai-approved Label gesetzt wird auf auto/ branches
    if: |
      github.event.action == 'labeled' &&
      github.event.label.name == 'ai-approved' &&
      startsWith(github.event.pull_request.head.ref, 'auto/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: React with rocket emoji
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/reactions \
            -f content=rocket

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --squash \
            --auto

  post-merge-summary:
    # Wird ausgefÃ¼hrt wenn PR gemerged wurde
    if: |
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'auto/')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract spec ID and find issue
        id: extract
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract spec-id from branch name
          BRANCH="${{ github.event.pull_request.head.ref }}"
          SPEC_ID=$(echo "$BRANCH" | sed 's|auto/||')
          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT

          # Find issue number from PR body
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oP '#\K\d+' | head -1 || echo "")

          if [ -z "$ISSUE_NUM" ]; then
            # Fallback: Search for issue by spec ID
            ISSUE_NUM=$(gh issue list --label plot-request --search "$SPEC_ID in:title" --json number -q '.[0].number' || echo "")
          fi

          echo "issue_num=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Found spec ID: $SPEC_ID, Issue: #$ISSUE_NUM"

      - name: Find implementation files
        id: files
        run: |
          SPEC_ID="${{ steps.extract.outputs.spec_id }}"

          # Find all implementation files for this spec
          MATPLOTLIB_FILE=$(find plots/matplotlib -name "default.py" -path "*/$SPEC_ID/*" 2>/dev/null | head -1 || echo "")
          SEABORN_FILE=$(find plots/seaborn -name "default.py" -path "*/$SPEC_ID/*" 2>/dev/null | head -1 || echo "")

          echo "matplotlib=$MATPLOTLIB_FILE" >> $GITHUB_OUTPUT
          echo "seaborn=$SEABORN_FILE" >> $GITHUB_OUTPUT

      - name: Post summary to Issue
        if: steps.extract.outputs.issue_num != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.extract.outputs.issue_num }}"
          SPEC_ID="${{ steps.extract.outputs.spec_id }}"
          PR_NUM="${{ github.event.pull_request.number }}"
          MERGE_COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
          SHORT_SHA=$(echo "$MERGE_COMMIT" | cut -c1-7)

          MATPLOTLIB_FILE="${{ steps.files.outputs.matplotlib }}"
          SEABORN_FILE="${{ steps.files.outputs.seaborn }}"

          # Build implementations list
          IMPL_LIST=""
          if [ -n "$MATPLOTLIB_FILE" ]; then
            IMPL_LIST="${IMPL_LIST}
          - matplotlib: \`$MATPLOTLIB_FILE\`"
          fi
          if [ -n "$SEABORN_FILE" ]; then
            IMPL_LIST="${IMPL_LIST}
          - seaborn: \`$SEABORN_FILE\`"
          fi

          COMMENT_BODY="## âœ… Implementation Complete

          **Spec ID:** \`$SPEC_ID\`
          **PR:** #$PR_NUM (merged)
          **Commit:** [$SHORT_SHA](https://github.com/${{ github.repository }}/commit/$MERGE_COMMIT)

          ### Implementations
          $IMPL_LIST

          ### Spec File
          - \`specs/$SPEC_ID.md\`

          ---
          ðŸ¤– *Auto-generated by pyplots CI*"

          gh issue comment "$ISSUE_NUM" --body "$COMMENT_BODY"
          echo "âœ… Posted summary to issue #$ISSUE_NUM"

      - name: Close the issue
        if: steps.extract.outputs.issue_num != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue close "${{ steps.extract.outputs.issue_num }}" \
            --reason completed \
            --comment "ðŸŽ‰ This plot request has been implemented and merged!"
