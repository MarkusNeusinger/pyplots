name: Quality Check

on:
  workflow_run:
    workflows: ["Test and Generate Previews"]
    types: [completed]

jobs:
  quality-check:
    name: AI Quality Evaluation
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download preview metadata
        uses: actions/download-artifact@v4
        with:
          name: preview-metadata
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load metadata
        id: metadata
        run: |
          if [ ! -f preview_metadata.json ]; then
            echo "No preview metadata found, skipping quality check"
            exit 0
          fi

          PR_NUMBER=$(jq -r '.pr_number' preview_metadata.json)
          BUCKET=$(jq -r '.bucket' preview_metadata.json)
          BASE_PATH=$(jq -r '.base_path' preview_metadata.json)
          CHANGED_FILES=$(jq -r '.changed_files[]' preview_metadata.json | tr '\n' ' ')

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "bucket=$BUCKET" >> $GITHUB_OUTPUT
          echo "base_path=$BASE_PATH" >> $GITHUB_OUTPUT
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Setup Google Cloud authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_CREDENTIALS }}

      - name: Download preview images
        run: |
          mkdir -p preview_images
          gsutil -m cp -r "gs://${{ steps.metadata.outputs.bucket }}/${{ steps.metadata.outputs.base_path }}/*" preview_images/ || echo "No images to download"

      - name: Quality evaluation with Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            TASK: Evaluate plot implementations against specifications

            PR: #${{ steps.metadata.outputs.pr_number }}
            Preview images location: preview_images/

            Instructions:
            1. List all PNG files in preview_images/ directory
            2. For each preview image:
               a. Parse filename to extract: spec_id, library, variant
               b. Read corresponding spec file: specs/{spec_id}.md
               c. View the preview image
               d. Evaluate against quality criteria in spec

            3. For each implementation, check:
               - Does it meet ALL quality criteria listed in spec?
               - Are visual elements clear and readable?
               - Are colors appropriate and accessible?
               - Is the layout well-structured?
               - Score: 0-100 (≥85 to pass)

            4. Generate quality report with:
               - Overall verdict (PASS if all ≥85, FAIL otherwise)
               - Score for each implementation
               - Specific feedback for each quality criterion
               - Strengths and improvements needed

            5. Use gh CLI to:
               - Post quality report as comment on PR #${{ steps.metadata.outputs.pr_number }}
               - Add label "quality-approved" if PASS
               - Add label "quality-check-failed" if FAIL

            Scoring Guidelines:
            - 90-100: Excellent - All criteria met, production ready
            - 85-89: Good - Minor issues, acceptable
            - 75-84: Needs improvement
            - <75: Rejected - Major issues

            Be objective and constructive in your feedback.
