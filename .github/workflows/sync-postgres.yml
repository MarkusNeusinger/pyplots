name: "Sync: PostgreSQL"
run-name: "Sync specs to DB: ${{ github.ref_name }}"

# Syncs specs, metadata, and implementations from main branch to PostgreSQL.
# This ensures the database only contains data for code that is actually in main.
#
# Data sources:
# - specs/*.md: Spec descriptions, data requirements
# - metadata/*.yaml: Structured tags, generation info, quality scores
# - plots/**/*.py: Implementation files

on:
  push:
    branches:
      - main
    paths:
      - 'specs/**'
      - 'metadata/**'
      - 'plots/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  sync:
    name: Sync to PostgreSQL
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v6

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.13'

    - name: Install uv
      uses: astral-sh/setup-uv@v7

    - name: Install dependencies
      run: |
        uv sync

    - name: Run database migrations
      run: |
        uv run alembic upgrade head
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Sync specs and implementations
      run: |
        uv run python scripts/sync_to_postgres.py
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        GCS_BUCKET: ${{ vars.GCS_BUCKET || 'pyplots-images' }}

    - name: Summary
      run: |
        echo "### Sync Complete" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Specs, metadata, and implementations have been synced to PostgreSQL." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Data synced:**" >> $GITHUB_STEP_SUMMARY
        echo "- specs/*.md (descriptions, data requirements)" >> $GITHUB_STEP_SUMMARY
        echo "- metadata/*.yaml (tags, generation info, quality scores)" >> $GITHUB_STEP_SUMMARY
        echo "- plots/**/*.py (implementation files)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Trigger:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
