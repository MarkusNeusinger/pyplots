name: "Gen: New Plot"
run-name: "Generate: ${{ github.event.issue.title }}"

on:
  issues:
    types: [labeled]

concurrency:
  group: spec-to-code-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  trigger-claude-code:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # Allow commits
      pull-requests: write   # Allow PR creation
      issues: write         # Allow issue comments
      id-token: write       # Required for Claude Code authentication
      actions: read         # Allow Claude to read CI results

    steps:
      - name: Check conditions
        id: check
        run: |
          echo "=== Debug Info ==="
          echo "Label added: ${{ github.event.label.name }}"
          echo "Issue labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"
          echo "=================="

          # Check 1: Must be "approved" label being added
          if [[ "${{ github.event.label.name }}" != "approved" ]]; then
            echo "::notice::Skipping: Not the 'approved' label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check 2: Issue must have "plot-request" label
          HAS_PLOT_REQUEST="${{ contains(github.event.issue.labels.*.name, 'plot-request') }}"
          if [[ "$HAS_PLOT_REQUEST" != "true" ]]; then
            echo "::notice::Skipping: Issue does not have 'plot-request' label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "::notice::All conditions met - proceeding with code generation"
          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # Full history for better context

      - name: React with eyes emoji
        if: steps.check.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=eyes

      - name: Extract spec ID from issue
        if: steps.check.outputs.should_run == 'true'
        id: extract_spec
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Check if issue was marked as duplicate
          COMMENTS=$(gh issue view ${{ github.event.issue.number }} --json comments -q '.comments[].body')

          if echo "$COMMENTS" | grep -q "Duplicate Detected"; then
            echo "❌ This issue was marked as a duplicate by validate-plot-request workflow"
            echo "Please review the duplicate notice and either:"
            echo "  1. Use the existing spec mentioned in the comment"
            echo "  2. Update the issue with unique requirements and re-run validation"
            exit 1
          fi

          # Extract spec ID from issue comments (assigned by validate-plot-request workflow)
          # Look for "**Assigned ID:** `spec-id`" pattern in comments
          SPEC_ID=$(echo "$COMMENTS" | grep -oP '\*\*Assigned ID:\*\* `\K[a-z0-9-]+(?=`)' | tail -1 || echo "")

          if [ -z "$SPEC_ID" ]; then
            # Fallback: Check for existing spec reference (for duplicates that should use existing)
            SPEC_ID=$(echo "$COMMENTS" | grep -oP '\*\*Existing Spec:\*\* `\K[a-z0-9-]+(?=`)' | tail -1 || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            # Fallback: Try to extract from title (format: "spec-id: Title" or just "spec-id")
            # New format: {type}-{variant}-{modifier} (no numbers required)
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oiP '^[a-z]+-[a-z]+(-[a-z0-9]+)?' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            # Try legacy format with numbers for backwards compatibility
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oiP '^[a-z]+-[a-z]+-\d{3,4}' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            echo "❌ Could not extract spec ID from issue"
            echo "Expected: Assigned ID in comments (from validate-plot-request workflow)"
            echo "Or title format: {type}-{variant}-{modifier}"
            echo "Examples: scatter-basic, scatter-color-mapped, heatmap-correlation"
            exit 1
          fi

          # Validate spec file exists
          if [ ! -f "specs/${SPEC_ID}.md" ]; then
            echo "⚠️  Warning: Spec file specs/${SPEC_ID}.md does not exist"
            echo "Claude Code will create it from the issue body"
          fi

          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "✅ Extracted spec ID: $SPEC_ID"

      - name: Run Claude Code to generate implementations
        if: steps.check.outputs.should_run == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--model opus"
          additional_permissions: |
            actions: read
          prompt: |
            ## Task: Generate Plot Implementations

            Generate implementations for **${{ steps.extract_spec.outputs.spec_id }}** for all 8 libraries.

            ### Read these files first:
            1. `prompts/plot-generator.md` - Base generation rules
            2. `prompts/quality-criteria.md` - Quality requirements
            3. `specs/${{ steps.extract_spec.outputs.spec_id }}.md` - The specification (create from issue body if missing)

            ### For each library, also read:
            - `prompts/library/{library}.md` - Library-specific rules

            ### Generate implementations for:
            1. matplotlib → `plots/matplotlib/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
            2. seaborn → `plots/seaborn/{function}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
            3. plotly → `plots/plotly/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
            4. bokeh → `plots/bokeh/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
            5. altair → `plots/altair/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
            6. plotnine → `plots/plotnine/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
            7. pygal → `plots/pygal/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
            8. highcharts → `plots/highcharts/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`

            ### Create PR:
            - Branch: `auto/${{ steps.extract_spec.outputs.spec_id }}`
            - Title: `feat: implement ${{ steps.extract_spec.outputs.spec_id }}`
            - Link to issue #${{ github.event.issue.number }}
