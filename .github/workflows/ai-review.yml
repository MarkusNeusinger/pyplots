name: AI Review

on:
  workflow_run:
    workflows: ["Test and Generate Previews"]
    types: [completed]

jobs:
  ai-review:
    # Nur wenn Tests erfolgreich waren
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download preview metadata
        uses: actions/download-artifact@v4
        with:
          name: preview-metadata
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load metadata
        id: metadata
        run: |
          if [ ! -f preview_metadata.json ]; then
            echo "No preview metadata found, skipping AI review"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_NUMBER=$(jq -r '.pr_number' preview_metadata.json)
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Get PR details
        if: steps.metadata.outputs.skip != 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh pr view ${{ steps.metadata.outputs.pr_number }} --json headRefName,number)
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')

          # Check if auto/ branch
          if [[ ! "$HEAD_REF" =~ ^auto/ ]]; then
            echo "Not an auto/ branch, skipping AI review"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract spec-id from branch name (auto/scatter-basic-005)
          SPEC_ID=$(echo "$HEAD_REF" | sed 's|auto/||')
          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Spec ID: $SPEC_ID"

      - name: Setup Google Cloud authentication
        if: steps.pr.outputs.skip != 'true'
        id: gcs_auth
        continue-on-error: true
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_CREDENTIALS }}

      - name: Download preview images
        if: steps.pr.outputs.skip != 'true' && steps.gcs_auth.outcome == 'success'
        run: |
          mkdir -p preview_images
          gsutil -m cp -r "gs://${{ secrets.GCS_BUCKET }}/previews/pr-${{ steps.metadata.outputs.pr_number }}/*" preview_images/ || echo "No preview images found"

      - name: Check attempt count
        if: steps.pr.outputs.skip != 'true'
        id: attempts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABELS=$(gh pr view ${{ steps.metadata.outputs.pr_number }} --json labels -q '.labels[].name' 2>/dev/null || echo "")

          if echo "$LABELS" | grep -q "ai-attempt-3"; then
            echo "count=3" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "ai-attempt-2"; then
            echo "count=2" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "ai-attempt-1"; then
            echo "count=1" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: React with eyes emoji
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count != '3'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.metadata.outputs.pr_number }}/reactions \
            -f content=eyes

      - name: Trigger Claude Quality Check
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count != '3'
        uses: actions/github-script@v7
        with:
          script: |
            const specId = '${{ steps.pr.outputs.spec_id }}';
            const attempt = parseInt('${{ steps.attempts.outputs.count }}') + 1;
            const prNumber = ${{ steps.metadata.outputs.pr_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `@claude

            ## ðŸŽ¯ Task: AI Quality Review (Attempt ${attempt}/3)

            Tests passed and preview images are ready. Evaluate if the implementation matches the specification.

            ### Your Task

            1. **Read the spec file**: \`specs/${specId}.md\`
               - Understand all quality criteria listed
               - Note the expected visual output

            2. **Read the implementation files**:
               - \`plots/matplotlib/scatter/${specId}/default.py\`
               - \`plots/seaborn/scatterplot/${specId}/default.py\`

            3. **View the preview images** in \`preview_images/\` directory
               - Use your vision capabilities to analyze each image
               - Compare with the spec requirements

            4. **Score each implementation (0-100)**:
               - Does it match ALL quality criteria from spec?
               - Is the visual output correct?
               - Is the code clean and follows best practices?

            5. **Post your verdict**:
               - If ALL implementations score â‰¥85:
                 - Post "âœ… AI REVIEW APPROVED"
                 - Run: \`gh pr edit ${prNumber} --add-label ai-approved\`
               - If ANY implementation scores <85:
                 - Post detailed feedback for regeneration
                 - Run: \`gh pr edit ${prNumber} --add-label ai-attempt-${attempt}\`
                 - If attempt < 3: regenerate the failing implementation
                 - If attempt 3: Run \`gh pr edit ${prNumber} --add-label ai-failed\`

            Be specific and actionable in your feedback!`
            });

      - name: Mark as failed after 3 attempts
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count == '3'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.metadata.outputs.pr_number }} --add-label "ai-failed"
          gh pr comment ${{ steps.metadata.outputs.pr_number }} \
            --body "âŒ AI Review failed after 3 attempts. Manual review required."
