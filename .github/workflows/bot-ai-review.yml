name: "Bot: AI Review"
run-name: "AI Review: ${{ github.event.workflow_run.head_branch || github.event.pull_request.head.ref }}"

on:
  workflow_run:
    workflows: ["Gen: Preview Images"]
    types: [completed]

jobs:
  ai-review:
    # Only run when preview generation was successful
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download plot metadata
        uses: actions/download-artifact@v4
        with:
          name: plot-metadata
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load metadata
        id: metadata
        run: |
          if [ ! -f plot_metadata.json ]; then
            echo "No plot metadata found, skipping AI review"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_NUMBER=$(jq -r '.pr_number' plot_metadata.json)
          ISSUE_NUMBER=$(jq -r '.issue_number // empty' plot_metadata.json)
          SUB_ISSUE_NUMBER=$(jq -r '.sub_issue_number // empty' plot_metadata.json)
          TIMESTAMP=$(jq -r '.timestamp' plot_metadata.json)
          LIBRARY=$(jq -r '.library // empty' plot_metadata.json)

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "sub_issue_number=$SUB_ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "library=$LIBRARY" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Get PR details
        if: steps.metadata.outputs.skip != 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh pr view ${{ steps.metadata.outputs.pr_number }} --json headRefName,number,body)
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')
          PR_BODY=$(echo "$PR_DATA" | jq -r '.body')

          # Check if auto/ branch (now includes library: auto/scatter-basic/matplotlib)
          if [[ ! "$HEAD_REF" =~ ^auto/ ]]; then
            echo "Not an auto/ branch, skipping AI review"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract spec-id and library from branch name
          # Format: auto/{spec-id}/{library}
          SPEC_ID=$(echo "$HEAD_REF" | cut -d'/' -f2)
          LIBRARY=$(echo "$HEAD_REF" | cut -d'/' -f3)

          # If library not in branch, try from metadata
          if [ -z "$LIBRARY" ]; then
            LIBRARY="${{ steps.metadata.outputs.library }}"
          fi

          # Extract sub-issue from PR body if not in metadata
          SUB_ISSUE="${{ steps.metadata.outputs.sub_issue_number }}"
          if [ -z "$SUB_ISSUE" ]; then
            SUB_ISSUE=$(echo "$PR_BODY" | grep -oP 'Sub-Issue: #\K\d+' | head -1 || echo "")
          fi

          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "library=$LIBRARY" >> $GITHUB_OUTPUT
          echo "sub_issue=$SUB_ISSUE" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Spec ID: $SPEC_ID, Library: $LIBRARY, Sub-Issue: #$SUB_ISSUE"

      - name: Setup Google Cloud authentication
        if: steps.pr.outputs.skip != 'true'
        id: gcs_auth
        continue-on-error: true
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_CREDENTIALS }}

      - name: Setup gcloud CLI
        if: steps.pr.outputs.skip != 'true' && steps.gcs_auth.outcome == 'success'
        uses: google-github-actions/setup-gcloud@v2

      - name: Download plot images
        if: steps.pr.outputs.skip != 'true' && steps.gcs_auth.outcome == 'success'
        run: |
          SPEC_ID="${{ steps.pr.outputs.spec_id }}"
          LIBRARY="${{ steps.pr.outputs.library }}"
          TIMESTAMP="${{ steps.metadata.outputs.timestamp }}"

          mkdir -p plot_images

          # Download plot images for this specific library
          gsutil -m cp -r "gs://${{ secrets.GCS_BUCKET }}/plots/${SPEC_ID}/${LIBRARY}/**/*v${TIMESTAMP}*.png" plot_images/ 2>/dev/null || echo "No plot images found"

          echo "Downloaded plot images:"
          find plot_images -name "*.png" -type f 2>/dev/null || echo "No images found"

      - name: Check attempt count
        if: steps.pr.outputs.skip != 'true'
        id: attempts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABELS=$(gh pr view ${{ steps.metadata.outputs.pr_number }} --json labels -q '.labels[].name' 2>/dev/null || echo "")

          if echo "$LABELS" | grep -q "ai-attempt-3"; then
            echo "count=3" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "ai-attempt-2"; then
            echo "count=2" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "ai-attempt-1"; then
            echo "count=1" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: Update sub-issue label to reviewing
        if: steps.pr.outputs.skip != 'true' && steps.pr.outputs.sub_issue != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ steps.pr.outputs.sub_issue }} \
            --remove-label "testing" \
            --add-label "reviewing" 2>/dev/null || true

      - name: React with eyes emoji
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count != '3'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.metadata.outputs.pr_number }}/reactions \
            -f content=eyes

      - name: Trigger Claude Quality Check
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count != '3'
        uses: actions/github-script@v7
        with:
          script: |
            const specId = '${{ steps.pr.outputs.spec_id }}';
            const library = '${{ steps.pr.outputs.library }}';
            const attempt = parseInt('${{ steps.attempts.outputs.count }}') + 1;
            const prNumber = ${{ steps.metadata.outputs.pr_number }};
            const subIssueNumber = '${{ steps.pr.outputs.sub_issue }}';
            const mainIssueNumber = '${{ steps.metadata.outputs.issue_number }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `@claude

            ## Task: AI Quality Review for **${library}** (Attempt ${attempt}/3)

            Tests passed and preview images are ready. Evaluate if the **${library}** implementation matches the specification.

            ### Your Task

            1. **Read the spec file**: \`specs/${specId}.md\`
               - Note all quality criteria listed
               - Understand the expected visual output

            2. **Read the ${library} implementation**:
               - \`plots/${library}/*/${specId}/default.py\`

            3. **Read library-specific rules**:
               - \`prompts/library/${library}.md\`

            4. **View the plot images** in \`plot_images/\` directory
               - Use your vision capabilities to analyze each image
               - Compare with the spec requirements

            5. **Evaluate against quality criteria** from \`prompts/quality-criteria.md\`

            6. **Post your verdict to Sub-Issue #${subIssueNumber}** using this EXACT format:

            \`\`\`markdown
            ## AI Review - Attempt ${attempt}/3

            ### Quality Evaluation
            | Evaluator | Score | Verdict |
            |-----------|-------|---------|
            | Claude | XX/100 | approve/reject |

            ### Criteria Checklist
            - [x] VQ-001: Axes labeled correctly
            - [x] VQ-002: Grid is subtle
            - [ ] VQ-003: Elements clear â† Issue here
            - [x] CQ-001: Type hints present
            ...

            ### Issues Found
            1. **VQ-003 FAILED**: Legend overlaps with data points
            2. **CQ-002 PARTIAL**: Docstring missing return type

            ### AI Feedback for Next Attempt
            > Move legend outside plot area with \\\`bbox_to_anchor=(1.05, 1)\\\`
            > Add return type to docstring

            ### Verdict: APPROVED / REJECTED
            \`\`\`

            7. **Take action based on result**:
               - **APPROVED** (score >= 85):
                 - Run: \`gh pr edit ${prNumber} --add-label ai-approved\`
                 - Run: \`gh issue edit ${subIssueNumber} --remove-label reviewing --add-label ai-approved\`
               - **REJECTED** (score < 85):
                 - Run: \`gh pr edit ${prNumber} --add-label ai-rejected\`
                 - Run: \`gh issue edit ${subIssueNumber} --remove-label reviewing --add-label ai-rejected\`

            **IMPORTANT:**
            - This is a **${library}-only** review - focus only on this library
            - Post feedback to **Sub-Issue #${subIssueNumber}**, NOT the main issue
            - Include the generated code in your review comment for documentation`
            });

      - name: Mark as failed after 3 attempts
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count == '3'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SUB_ISSUE="${{ steps.pr.outputs.sub_issue }}"
          PR_NUM="${{ steps.metadata.outputs.pr_number }}"
          LIBRARY="${{ steps.pr.outputs.library }}"
          SPEC_ID="${{ steps.pr.outputs.spec_id }}"

          # Update PR labels
          gh pr edit "$PR_NUM" --add-label "ai-rejected"

          # Update sub-issue
          if [ -n "$SUB_ISSUE" ]; then
            gh issue edit "$SUB_ISSUE" \
              --remove-label "reviewing,ai-rejected" \
              --add-label "not-feasible"

            # Post final status to sub-issue
            gh issue comment "$SUB_ISSUE" --body "## AI Review - Final Status

            ### Status: Not Feasible

            AI Review failed after **3 attempts**. This ${LIBRARY} implementation for \`${SPEC_ID}\` could not meet quality standards.

            **Options:**
            1. Manual review and fix
            2. Wait for improved AI capabilities
            3. Mark this library as unsupported for this plot type

            ---
            :robot: *Automated quality check*"
          fi

          # Post to PR
          gh pr comment "$PR_NUM" --body "AI Review failed after 3 attempts. See sub-issue #$SUB_ISSUE for details."
