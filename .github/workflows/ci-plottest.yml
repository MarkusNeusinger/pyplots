name: "CI: Plot Tests"
run-name: "Plot Tests: ${{ github.head_ref }}"

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
    paths:
      - 'plots/**/*.py'
      - 'specs/**/*.md'

jobs:
  test-plots:
    name: Test Plots on Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        python-version: [ '3.13' ]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Find changed plot files and detect libraries
        id: detect_libs
        run: |
          # Get list of changed Python files in plots/
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD -- 'plots/**/*.py' || echo "")

          if [ -z "$CHANGED_FILES" ]; then
            echo "No plot files changed"
            echo "has_plots=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "has_plots=true" >> $GITHUB_OUTPUT
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Extract unique libraries from changed files (plots/{library}/...)
          LIBRARIES=$(echo "$CHANGED_FILES" | sed -n 's|^plots/\([^/]*\)/.*|\1|p' | sort -u | tr '\n' ' ')
          echo "libraries=$LIBRARIES" >> $GITHUB_OUTPUT
          echo "Changed libraries: $LIBRARIES"

      - name: Install library-specific dependencies
        if: steps.detect_libs.outputs.has_plots == 'true'
        run: |
          uv venv .venv
          source .venv/bin/activate

          # Library-specific dependencies mapping (same as gen-new-plot.yml)
          declare -A DEPS
          DEPS[matplotlib]="matplotlib>=3.9.0 numpy>=1.26.0"
          DEPS[seaborn]="seaborn>=0.13.0 matplotlib numpy>=1.26.0"
          DEPS[plotly]="plotly>=5.18.0 kaleido>=0.2.1 numpy>=1.26.0"
          DEPS[bokeh]="bokeh>=3.4.0 numpy>=1.26.0"
          DEPS[altair]="altair>=5.2.0 vl-convert-python>=1.3.0 numpy>=1.26.0"
          DEPS[plotnine]="plotnine>=0.13.0 numpy>=1.26.0"
          DEPS[pygal]="pygal>=3.0.0 cairosvg>=2.7.0"
          DEPS[highcharts]="highcharts-core>=1.10.0 numpy>=1.26.0"
          DEPS[letsplot]="lets-plot>=4.5.0"

          # Install pandas (common dependency) first
          uv pip install pandas>=2.2.0

          # Install only dependencies for changed libraries
          for LIB in ${{ steps.detect_libs.outputs.libraries }}; do
            if [ -n "${DEPS[$LIB]}" ]; then
              echo "üì¶ Installing dependencies for $LIB: ${DEPS[$LIB]}"
              uv pip install ${DEPS[$LIB]} || {
                echo "‚ö†Ô∏è Warning: Failed to install $LIB dependencies, skipping"
                continue
              }
            else
              echo "‚ö†Ô∏è Unknown library: $LIB"
            fi
          done

      - name: Install Inter font
        run: |
          mkdir -p ~/.local/share/fonts
          curl -sL "https://github.com/rsms/inter/releases/download/v4.1/Inter-4.1.zip" -o /tmp/inter.zip
          unzip -q /tmp/inter.zip -d /tmp/inter
          cp /tmp/inter/Inter*.ttf ~/.local/share/fonts/ 2>/dev/null || cp /tmp/inter/Inter*.otf ~/.local/share/fonts/ 2>/dev/null || true
          fc-cache -f
          echo "Inter font installed"

      - name: Test plot execution
        id: test_execution
        if: steps.detect_libs.outputs.has_plots == 'true'
        run: |
          source .venv/bin/activate
          echo "üß™ Testing plot files on Python ${{ matrix.python-version }}"
          echo "üìö Libraries detected: ${{ steps.detect_libs.outputs.libraries }}"

          FAILED=0
          PASSED=0
          SKIPPED=0

          while IFS= read -r file; do
            if [ -z "$file" ]; then continue; fi

            # Extract library from file path
            LIB=$(echo "$file" | sed -n 's|^plots/\([^/]*\)/.*|\1|p')

            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "üìä Testing: $file ($LIB)"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Run with non-interactive backend
            if MPLBACKEND=Agg python "$file" 2>&1; then
              echo "‚úÖ PASSED: $file"
              PASSED=$((PASSED + 1))
            else
              echo "‚ùå FAILED: $file"
              FAILED=$((FAILED + 1))
            fi
          done <<< "${{ steps.detect_libs.outputs.files }}"

          echo ""
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìã Summary: $PASSED passed, $FAILED failed"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

          # Save results for later aggregation
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILED" >> $GITHUB_OUTPUT

          if [ $FAILED -gt 0 ]; then
            echo "::error::$FAILED plot(s) failed execution on Python ${{ matrix.python-version }}"
            exit 1
          fi

      - name: Skip message
        if: steps.detect_libs.outputs.has_plots != 'true'
        run: |
          echo "‚ÑπÔ∏è No plot files changed in this PR - skipping tests"

      - name: Save test results
        if: always()
        run: |
          mkdir -p test-results
          echo "${{ matrix.python-version }},${{ steps.test_execution.outcome || 'skipped' }}" > test-results/result-${{ matrix.python-version }}.txt

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: test-results-${{ matrix.python-version }}
          path: test-results/
          retention-days: 30

  # Summary job: post compact PR comment with test results
  summary:
    name: Post Test Summary
    needs: test-plots
    if: always()
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v6
        with:
          pattern: test-results-*
          merge-multiple: true

      - name: Build summary comment
        id: summary
        run: |
          # Parse results (Python 3.13 only)
          PY313_RESULT=$(cat result-3.13.txt 2>/dev/null | cut -d',' -f2 || echo "skipped")

          # Helper function for badge
          badge() {
            local version=$1
            local result=$2
            if [ "$result" == "success" ]; then
              echo "![${version}](https://img.shields.io/badge/${version}-pass-brightgreen)"
            elif [ "$result" == "failure" ]; then
              echo "![${version}](https://img.shields.io/badge/${version}-fail-red)"
            else
              echo "![${version}](https://img.shields.io/badge/${version}-skip-lightgrey)"
            fi
          }

          # Build comment
          if [ "$PY313_RESULT" == "success" ]; then
            HEADER="## ‚úÖ Plot Tests Passed"
            MAIN_STATUS="**Tested with Python 3.13**"
          elif [ "$PY313_RESULT" == "failure" ]; then
            HEADER="## ‚ùå Plot Tests Failed"
            MAIN_STATUS="**Python 3.13 tests failed**"
          else
            HEADER="## ‚è≠Ô∏è Plot Tests Skipped"
            MAIN_STATUS="No plot files changed"
          fi

          # Build badge
          B313=$(badge "3.13" "$PY313_RESULT")

          cat > /tmp/comment.md << EOF
          ${HEADER}

          ${MAIN_STATUS}

          **Python:** ${B313}
          EOF

          cat /tmp/comment.md
          echo "has_comment=true" >> $GITHUB_OUTPUT

      - name: Post PR comment
        if: steps.summary.outputs.has_comment == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const comment = fs.readFileSync('/tmp/comment.md', 'utf8');

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('Plot Tests')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
