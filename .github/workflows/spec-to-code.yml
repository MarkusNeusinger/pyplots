name: Generate Code from Spec

on:
  issues:
    types: [labeled]

jobs:
  generate-code:
    # Only run when "approved" label is added
    if: github.event.label.name == 'approved'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract spec ID from issue
        id: extract_spec
        env:
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Try to extract spec ID from title (format: "scatter-basic-001: Title" or just "scatter-basic-001")
          SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oP '^[a-z]+-[a-z]+-\d{3}' || echo "")

          if [ -z "$SPEC_ID" ]; then
            # Try to find spec ID in body (look for markdown heading like "# scatter-basic-001:")
            SPEC_ID=$(echo "$ISSUE_BODY" | grep -oP '^#\s*\K[a-z]+-[a-z]+-\d{3}' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            echo "âŒ Could not extract spec ID from issue"
            exit 1
          fi

          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "âœ… Extracted spec ID: $SPEC_ID"

      - name: Check if spec file exists
        id: check_spec
        run: |
          SPEC_ID="${{ steps.extract_spec.outputs.spec_id }}"
          SPEC_FILE="specs/${SPEC_ID}.md"

          if [ ! -f "$SPEC_FILE" ]; then
            echo "Creating spec file from issue..."
            mkdir -p specs
            echo "${{ github.event.issue.body }}" > "$SPEC_FILE"

            git config --global user.name "github-actions[bot]"
            git config --global user.email "github-actions[bot]@users.noreply.github.com"
            git add "$SPEC_FILE"
            git commit -m "feat: add spec file for $SPEC_ID from issue #${{ github.event.issue.number }}"
          else
            echo "âœ… Spec file exists: $SPEC_FILE"
          fi

      - name: Generate implementations with Claude Code
        id: generate
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            TASK: Generate plot implementations from specification

            SPEC_ID: ${{ steps.extract_spec.outputs.spec_id }}
            ISSUE: #${{ github.event.issue.number }}

            Instructions:
            1. Read the spec file: specs/${{ steps.extract_spec.outputs.spec_id }}.md
            2. Read generation rules: rules/generation/v1.0.0-draft/code-generation-rules.md
            3. Read quality criteria: rules/generation/v1.0.0-draft/quality-criteria.md
            4. Read self-review checklist: rules/generation/v1.0.0-draft/self-review-checklist.md

            5. Generate matplotlib implementation:
               - Target: plots/matplotlib/scatter/${{ steps.extract_spec.outputs.spec_id }}/default.py
               - Follow generation rules exactly
               - Implement all spec requirements
               - Use type hints, docstrings, validation
               - Add standalone execution block
               - Self-review: Max 3 attempts to pass quality criteria

            6. Generate seaborn implementation:
               - Target: plots/seaborn/scatterplot/${{ steps.extract_spec.outputs.spec_id }}/default.py
               - Same requirements as matplotlib

            7. Create summary in markdown format with:
               - Libraries generated (matplotlib, seaborn)
               - Self-review results for each
               - File paths created
               - Any issues encountered

            IMPORTANT:
            - Each implementation must pass self-review before moving to next
            - Use deterministic sample data (fixed seeds or hardcoded data)
            - Code must work standalone (no external files)
            - Follow Python 3.10+ syntax

            Output your work summary when complete.

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            feat: implement ${{ steps.extract_spec.outputs.spec_id }}

            Auto-generated implementations from issue #${{ github.event.issue.number }}
            Generated using Claude Code with versioned rules (v1.0.0-draft)

            - matplotlib implementation
            - seaborn implementation
          branch: auto/${{ steps.extract_spec.outputs.spec_id }}
          title: "feat: implement ${{ steps.extract_spec.outputs.spec_id }}"
          body: |
            ## ðŸ¤– Auto-generated Implementation

            This PR contains auto-generated code for **${{ steps.extract_spec.outputs.spec_id }}**

            **Source:** Issue #${{ github.event.issue.number }}
            **Generated by:** Claude Code Action with versioned rules (v1.0.0-draft)

            ### What was generated

            - âœ… matplotlib implementation (`plots/matplotlib/scatter/${{ steps.extract_spec.outputs.spec_id }}/default.py`)
            - âœ… seaborn implementation (`plots/seaborn/scatterplot/${{ steps.extract_spec.outputs.spec_id }}/default.py`)

            ### Next Steps

            - [ ] Review generated code
            - [ ] Run tests (triggered automatically on PR)
            - [ ] Generate previews (triggered automatically on PR)
            - [ ] Quality check (triggered automatically after previews)

            ### Generation Process

            1. âœ… Spec read from `specs/${{ steps.extract_spec.outputs.spec_id }}.md`
            2. âœ… Generation rules applied from `rules/generation/v1.0.0-draft/`
            3. âœ… Self-review loop completed (max 3 attempts per library)
            4. âœ… Code committed to branch

            ---

            *Generated by [Claude Code Action](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          labels: |
            code-generated
            auto-pr
          draft: false

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            const specId = '${{ steps.extract_spec.outputs.spec_id }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– Code Generation Complete

            Implementations for **${specId}** have been generated using Claude Code!

            **Generated:**
            - âœ… matplotlib
            - âœ… seaborn

            A pull request has been created with the generated code.

            ### Next Steps
            1. Multi-version tests will run automatically (Python 3.10-3.13)
            2. Preview images will be generated
            3. AI quality check will evaluate the implementations

            Check the [workflow run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) for details.`
            });
