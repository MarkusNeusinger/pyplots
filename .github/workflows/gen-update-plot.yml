name: Gen: Update Plot (Repair Loop)

on:
  pull_request:
    types: [labeled]

jobs:
  update-plot:
    name: Regenerate Plot from AI Feedback
    # Only run when ai-rejected label is added to auto/ branches
    if: |
      github.event.label.name == 'ai-rejected' &&
      startsWith(github.event.pull_request.head.ref, 'auto/')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Check attempt count
        id: check_attempts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          LABELS=$(gh pr view $PR_NUMBER --json labels -q '.labels[].name')

          # Count existing attempts
          ATTEMPT=0
          if echo "$LABELS" | grep -q "ai-attempt-1"; then ATTEMPT=1; fi
          if echo "$LABELS" | grep -q "ai-attempt-2"; then ATTEMPT=2; fi
          if echo "$LABELS" | grep -q "ai-attempt-3"; then ATTEMPT=3; fi

          NEXT_ATTEMPT=$((ATTEMPT + 1))

          if [ $NEXT_ATTEMPT -gt 3 ]; then
            echo "max_reached=true" >> $GITHUB_OUTPUT
            echo "‚ùå Maximum attempts (3) reached"
          else
            echo "max_reached=false" >> $GITHUB_OUTPUT
            echo "attempt=$NEXT_ATTEMPT" >> $GITHUB_OUTPUT
            echo "üîÑ Starting attempt $NEXT_ATTEMPT"
          fi

      - name: Mark as failed if max attempts reached
        if: steps.check_attempts.outputs.max_reached == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Remove ai-rejected, add ai-failed
          gh pr edit $PR_NUMBER --remove-label "ai-rejected" --add-label "ai-failed"

          # Post failure message
          gh pr comment $PR_NUMBER --body "## ‚ùå Auto-Repair Failed

          Maximum repair attempts (3) reached. This PR requires manual intervention.

          Please review the AI feedback and fix the issues manually, or close this PR.

          ---
          ü§ñ *[gen-update-plot workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

      - name: Checkout code
        if: steps.check_attempts.outputs.max_reached != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        if: steps.check_attempts.outputs.max_reached != 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install uv
        if: steps.check_attempts.outputs.max_reached != 'true'
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        if: steps.check_attempts.outputs.max_reached != 'true'
        run: |
          uv sync --all-extras

      - name: Extract spec ID and find issue
        if: steps.check_attempts.outputs.max_reached != 'true'
        id: extract_info
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"
          SPEC_ID=$(echo "$BRANCH" | sed 's/auto\///')
          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT

          # Find related issue
          PR_BODY="${{ github.event.pull_request.body }}"
          ISSUE_NUM=$(echo "$PR_BODY" | grep -oP '#\K\d+' | head -1 || echo "")

          if [ -z "$ISSUE_NUM" ]; then
            ISSUE_NUM=$(gh issue list --label plot-request --search "$SPEC_ID in:title" --json number -q '.[0].number' || echo "")
          fi

          echo "issue_num=$ISSUE_NUM" >> $GITHUB_OUTPUT
          echo "Found issue: #$ISSUE_NUM"

      - name: Get AI feedback from issue
        if: steps.check_attempts.outputs.max_reached != 'true' && steps.extract_info.outputs.issue_num != ''
        id: get_feedback
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.extract_info.outputs.issue_num }}"

          # Get latest AI Review comment from issue
          FEEDBACK=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUM/comments \
            --jq '[.[] | select(.body | contains("AI Review"))] | last | .body // empty')

          if [ -n "$FEEDBACK" ]; then
            echo "feedback<<EOF" >> $GITHUB_OUTPUT
            echo "$FEEDBACK" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "has_feedback=true" >> $GITHUB_OUTPUT
          else
            echo "has_feedback=false" >> $GITHUB_OUTPUT
          fi

      - name: Find and read current plot files
        if: steps.check_attempts.outputs.max_reached != 'true'
        id: read_plots
        run: |
          SPEC_ID="${{ steps.extract_info.outputs.spec_id }}"

          # Find all plot files for this spec
          PLOT_FILES=$(find plots -name "*.py" -path "*/${SPEC_ID}/*" 2>/dev/null)

          echo "plot_files<<EOF" >> $GITHUB_OUTPUT
          echo "$PLOT_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Read spec file
          if [ -f "specs/${SPEC_ID}.md" ]; then
            echo "spec_exists=true" >> $GITHUB_OUTPUT
          else
            echo "spec_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Update labels
        if: steps.check_attempts.outputs.max_reached != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          ATTEMPT="${{ steps.check_attempts.outputs.attempt }}"

          # Remove ai-rejected, add attempt label
          gh pr edit $PR_NUMBER --remove-label "ai-rejected" --add-label "ai-attempt-${ATTEMPT}"

      - name: Regenerate plot code
        if: steps.check_attempts.outputs.max_reached != 'true' && steps.get_feedback.outputs.has_feedback == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          SPEC_ID="${{ steps.extract_info.outputs.spec_id }}"
          FEEDBACK="${{ steps.get_feedback.outputs.feedback }}"
          ATTEMPT="${{ steps.check_attempts.outputs.attempt }}"

          echo "üîÑ Regenerating plot code (Attempt $ATTEMPT)"

          # Process each plot file
          echo "${{ steps.read_plots.outputs.plot_files }}" | while read -r plot_file; do
            if [ -z "$plot_file" ] || [ ! -f "$plot_file" ]; then continue; fi

            echo "üìù Processing: $plot_file"

            # Extract library from path
            LIBRARY=$(echo "$plot_file" | cut -d'/' -f2)

            # Read current code
            CURRENT_CODE=$(cat "$plot_file")

            # Read spec
            SPEC_CONTENT=$(cat "specs/${SPEC_ID}.md")

            # Create improvement prompt
            cat > /tmp/improve_prompt.txt << 'PROMPTEOF'
          You are improving a plot implementation based on AI review feedback.

          ## Current Code:
          ```python
          ${CURRENT_CODE}
          ```

          ## Specification:
          ${SPEC_CONTENT}

          ## AI Review Feedback:
          ${FEEDBACK}

          ## Task:
          Improve the code to address the feedback. Focus on:
          1. Fix any critical issues mentioned
          2. Implement improvement suggestions where feasible
          3. Maintain code quality and readability
          4. Keep the same function signature

          Return ONLY the improved Python code, no explanations or markdown formatting.
          PROMPTEOF

            # Replace placeholders (escape special chars)
            python3 << PYEOF
          import json
          with open('/tmp/improve_prompt.txt', 'r') as f:
              content = f.read()
          content = content.replace('\${CURRENT_CODE}', '''$CURRENT_CODE''')
          content = content.replace('\${SPEC_CONTENT}', '''$SPEC_CONTENT''')
          content = content.replace('\${FEEDBACK}', '''$FEEDBACK''')
          with open('/tmp/improve_prompt.txt', 'w') as f:
              f.write(content)
          PYEOF

            # Call Claude API
            RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
              -H "Content-Type: application/json" \
              -H "x-api-key: $ANTHROPIC_API_KEY" \
              -H "anthropic-version: 2023-06-01" \
              -d "{
                \"model\": \"claude-sonnet-4-20250514\",
                \"max_tokens\": 4096,
                \"messages\": [{
                  \"role\": \"user\",
                  \"content\": $(cat /tmp/improve_prompt.txt | jq -Rs .)
                }]
              }")

            # Extract improved code
            IMPROVED_CODE=$(echo "$RESPONSE" | jq -r '.content[0].text // empty')

            if [ -n "$IMPROVED_CODE" ]; then
              # Clean up markdown if present
              CLEAN_CODE=$(echo "$IMPROVED_CODE" | sed -n '/^```python/,/^```$/p' | sed '1d;$d')
              if [ -z "$CLEAN_CODE" ]; then
                CLEAN_CODE="$IMPROVED_CODE"
              fi

              # Write improved code
              echo "$CLEAN_CODE" > "$plot_file"
              echo "‚úÖ Updated: $plot_file"
            else
              echo "‚ö†Ô∏è No improvement generated for $plot_file"
            fi
          done

      - name: Commit and push changes
        if: steps.check_attempts.outputs.max_reached != 'true'
        run: |
          SPEC_ID="${{ steps.extract_info.outputs.spec_id }}"
          ATTEMPT="${{ steps.check_attempts.outputs.attempt }}"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
          else
            git add plots/
            git commit -m "fix(${SPEC_ID}): address AI review feedback (attempt ${ATTEMPT})

          ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: Claude <noreply@anthropic.com>"

            git push
            echo "‚úÖ Changes pushed"
          fi

      - name: Post update to issue
        if: steps.check_attempts.outputs.max_reached != 'true' && steps.extract_info.outputs.issue_num != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.extract_info.outputs.issue_num }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          ATTEMPT="${{ steps.check_attempts.outputs.attempt }}"

          cat > /tmp/update_comment.md << COMMENTEOF
          ## üîÑ Auto-Repair Attempt ${ATTEMPT}/3

          PR #${PR_NUMBER} has been updated based on AI review feedback.

          **Status:** Code regenerated and pushed. Waiting for new review.

          ---
          ü§ñ *[gen-update-plot workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
          COMMENTEOF

          gh issue comment "$ISSUE_NUM" --body-file /tmp/update_comment.md
