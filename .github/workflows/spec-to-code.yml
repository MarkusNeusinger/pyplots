name: Generate Code from Spec

on:
  issues:
    types: [labeled]

concurrency:
  group: spec-to-code-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  trigger-claude-code:
    # Only run when "approved" label is added to an issue that also has "plot-request"
    if: |
      github.event.label.name == 'approved' &&
      contains(github.event.issue.labels.*.name, 'plot-request')
    runs-on: ubuntu-latest
    permissions:
      contents: write        # Allow commits
      pull-requests: write   # Allow PR creation
      issues: write         # Allow issue comments
      id-token: write       # Required for Claude Code authentication
      actions: read         # Allow Claude to read CI results

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # Full history for better context

      - name: React with eyes emoji
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=eyes

      - name: Extract spec ID from issue
        id: extract_spec
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Extract spec ID from issue comments (assigned by validate-plot-request workflow)
          # Look for "**Assigned ID:** `spec-id`" pattern in comments
          SPEC_ID=$(gh issue view ${{ github.event.issue.number }} --json comments -q '.comments[].body' | \
            grep -oP '\*\*Assigned ID:\*\* `\K[a-z0-9-]+(?=`)' | tail -1 || echo "")

          if [ -z "$SPEC_ID" ]; then
            # Fallback: Try to extract from title (format: "spec-id: Title" or just "spec-id")
            # New format: {type}-{variant}-{modifier} (no numbers required)
            # Examples: scatter-basic, scatter-color-mapped, heatmap-correlation
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oiP '^[a-z]+-[a-z]+(-[a-z0-9]+)?' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            # Try legacy format with numbers for backwards compatibility
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oiP '^[a-z]+-[a-z]+-\d{3,4}' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            echo "âŒ Could not extract spec ID from issue"
            echo "Expected: Assigned ID in comments (from validate-plot-request workflow)"
            echo "Or title format: {type}-{variant}-{modifier}"
            echo "Examples: scatter-basic, scatter-color-mapped, heatmap-correlation"
            exit 1
          fi

          # Validate spec file exists
          if [ ! -f "specs/${SPEC_ID}.md" ]; then
            echo "âš ï¸  Warning: Spec file specs/${SPEC_ID}.md does not exist"
            echo "Claude Code will create it from the issue body"
          fi

          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "âœ… Extracted spec ID: $SPEC_ID"

      - name: Run Claude Code to generate implementations
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--model haiku" # Use Haiku model for testing Opus for production
          additional_permissions: |
            actions: read
          prompt: |
            ## ðŸŽ¯ Task: Generate Plot Implementations

            This issue has been approved! Please generate implementations for **${{ steps.extract_spec.outputs.spec_id }}**.

            ### Instructions

            1. **Read the specification**
               - File: `specs/${{ steps.extract_spec.outputs.spec_id }}.md`
               - If file doesn't exist, create it from the issue body

            2. **Read generation rules**
               - `rules/generation/v1.0.0-draft/code-generation-rules.md`
               - `rules/generation/v1.0.0-draft/quality-criteria.md`
               - `rules/generation/v1.0.0-draft/self-review-checklist.md`

            3. **Generate matplotlib implementation**
               - Target: `plots/matplotlib/scatter/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Follow generation rules exactly
               - Implement all spec requirements
               - Use type hints, docstrings, validation
               - Add standalone execution block (`if __name__ == '__main__':`)
               - Self-review: Max 3 attempts to pass quality criteria

            4. **Generate seaborn implementation**
               - Target: `plots/seaborn/scatterplot/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Same requirements as matplotlib

            5. **Create Pull Request**
               - Branch: `auto/${{ steps.extract_spec.outputs.spec_id }}`
               - Title: `feat: implement ${{ steps.extract_spec.outputs.spec_id }}`
               - Include summary of generation results
               - Link to this issue (#${{ github.event.issue.number }})

            ### Requirements
            - Each implementation must pass self-review before moving to next
            - Use deterministic sample data (fixed seeds or hardcoded data)
            - Code must work standalone (no external files)
            - Follow Python 3.10+ syntax
            - Commit with clear messages

            ### Expected Outcome
            - PR created with matplotlib and seaborn implementations
            - Both pass self-review (score â‰¥ 85)
            - Tests will run automatically on PR

            Please proceed with the generation!
