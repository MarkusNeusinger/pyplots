name: "Bot: Validate Plot Request"
run-name: "Validate: ${{ github.event.issue.title || 'Manual trigger' }}"

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to validate'
        required: true
        type: string
  issues:
    types: [labeled]

concurrency:
  group: validate-plot-request-${{ github.event.issue.number || github.run_id }}
  cancel-in-progress: false

jobs:
  validate-and-assign-id:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Check conditions
        id: check
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          LABEL_NAME: ${{ github.event.label.name }}
          HAS_LABEL: ${{ contains(github.event.issue.labels.*.name, 'plot-request') }}
          EVENT_ACTION: ${{ github.event.action }}
        run: |
          echo "=== Debug Info ==="
          echo "Event: ${{ github.event_name }}"
          echo "Action: $EVENT_ACTION"
          echo "Issue Number: $ISSUE_NUMBER"
          echo "Issue Title: $ISSUE_TITLE"
          echo "Labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"
          echo "Label added (if labeled event): $LABEL_NAME"
          echo "=================="

          # Check 1: Must have plot-request label
          if [[ "$HAS_LABEL" != "true" ]]; then
            echo "::notice::Skipping: Issue does not have 'plot-request' label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check 2: Must not already have spec ID in title
          # Spec ID format: [lowercase-with-hyphens] at the beginning, NOT [update...]
          # Valid spec-id: [scatter-basic], [line-timeseries-multi]
          # NOT spec-id: [update], [update:matplotlib], [Update:...]
          if [[ "$ISSUE_TITLE" =~ ^\[[a-z0-9-]+\] ]]; then
            FIRST_BRACKET=$(echo "$ISSUE_TITLE" | grep -oP '^\[\K[a-z0-9-]+(?=\])' || echo "")
            # Skip only if it's a valid spec-id (not an update marker)
            if [[ -n "$FIRST_BRACKET" && ! "$FIRST_BRACKET" =~ ^update ]]; then
              echo "::notice::Skipping: Issue title already has spec ID: $FIRST_BRACKET"
              echo "should_run=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # Check 3: For labeled events, only trigger when plot-request label is added
          if [[ "$EVENT_ACTION" == "labeled" && "$LABEL_NAME" != "plot-request" ]]; then
            echo "::notice::Skipping: Labeled event but not plot-request label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "::notice::All conditions met - proceeding with validation"
          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: React with eyes emoji
        if: steps.check.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=eyes

      - name: Run Claude Code to validate and assign spec ID
        if: steps.check.outputs.should_run == 'true'
        timeout-minutes: 60
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--model opus"
          prompt: |
            ## Task: Validate Plot Request and Assign Spec ID

            Read the rules from `prompts/spec-id-generator.md` and follow them.

            ### Issue Details
            - **Title:** ${{ github.event.issue.title }}
            - **Number:** #${{ github.event.issue.number }}
            - **Body:**
            ```
            ${{ github.event.issue.body }}
            ```

            ### Process
            1. Read `prompts/spec-id-generator.md` for full instructions
            2. List all existing specs in `specs/` directory
            3. Analyze the request and check for duplicates
            4. Post comment using `gh issue comment ${{ github.event.issue.number }} --body "..."`
            5. If NEW: Update title with `gh issue edit ${{ github.event.issue.number }} --title "..."`

            Workflow URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
