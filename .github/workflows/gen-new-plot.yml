name: "Gen: New Plot"
run-name: "Generate: ${{ github.event.issue.title }}"

on:
  issues:
    types: [labeled]

concurrency:
  group: spec-to-code-${{ github.event.issue.number }}
  cancel-in-progress: true

jobs:
  trigger-claude-code:
    runs-on: ubuntu-latest
    permissions:
      contents: write        # Allow commits
      pull-requests: write   # Allow PR creation
      issues: write         # Allow issue comments
      id-token: write       # Required for Claude Code authentication
      actions: read         # Allow Claude to read CI results

    steps:
      - name: Check conditions
        id: check
        run: |
          echo "=== Debug Info ==="
          echo "Label added: ${{ github.event.label.name }}"
          echo "Issue labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"
          echo "=================="

          # Check 1: Must be "approved" label being added
          if [[ "${{ github.event.label.name }}" != "approved" ]]; then
            echo "::notice::Skipping: Not the 'approved' label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check 2: Issue must have "plot-request" label
          HAS_PLOT_REQUEST="${{ contains(github.event.issue.labels.*.name, 'plot-request') }}"
          if [[ "$HAS_PLOT_REQUEST" != "true" ]]; then
            echo "::notice::Skipping: Issue does not have 'plot-request' label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "::notice::All conditions met - proceeding with code generation"
          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0    # Full history for better context

      - name: React with eyes emoji
        if: steps.check.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=eyes

      - name: Extract spec ID from issue
        if: steps.check.outputs.should_run == 'true'
        id: extract_spec
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Check if issue was marked as duplicate
          COMMENTS=$(gh issue view ${{ github.event.issue.number }} --json comments -q '.comments[].body')

          if echo "$COMMENTS" | grep -q "Duplicate Detected"; then
            echo "âŒ This issue was marked as a duplicate by validate-plot-request workflow"
            echo "Please review the duplicate notice and either:"
            echo "  1. Use the existing spec mentioned in the comment"
            echo "  2. Update the issue with unique requirements and re-run validation"
            exit 1
          fi

          # Extract spec ID from issue comments (assigned by validate-plot-request workflow)
          # Look for "**Assigned ID:** `spec-id`" pattern in comments
          SPEC_ID=$(echo "$COMMENTS" | grep -oP '\*\*Assigned ID:\*\* `\K[a-z0-9-]+(?=`)' | tail -1 || echo "")

          if [ -z "$SPEC_ID" ]; then
            # Fallback: Check for existing spec reference (for duplicates that should use existing)
            SPEC_ID=$(echo "$COMMENTS" | grep -oP '\*\*Existing Spec:\*\* `\K[a-z0-9-]+(?=`)' | tail -1 || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            # Fallback: Try to extract from title (format: "spec-id: Title" or just "spec-id")
            # New format: {type}-{variant}-{modifier} (no numbers required)
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oiP '^[a-z]+-[a-z]+(-[a-z0-9]+)?' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            # Try legacy format with numbers for backwards compatibility
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oiP '^[a-z]+-[a-z]+-\d{3,4}' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            echo "âŒ Could not extract spec ID from issue"
            echo "Expected: Assigned ID in comments (from validate-plot-request workflow)"
            echo "Or title format: {type}-{variant}-{modifier}"
            echo "Examples: scatter-basic, scatter-color-mapped, heatmap-correlation"
            exit 1
          fi

          # Validate spec file exists
          if [ ! -f "specs/${SPEC_ID}.md" ]; then
            echo "âš ï¸  Warning: Spec file specs/${SPEC_ID}.md does not exist"
            echo "Claude Code will create it from the issue body"
          fi

          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "âœ… Extracted spec ID: $SPEC_ID"

      - name: Run Claude Code to generate implementations
        if: steps.check.outputs.should_run == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--model opus" # Use Haiku model for testing Opus for production
          additional_permissions: |
            actions: read
          prompt: |
            ## ðŸŽ¯ Task: Generate Plot Implementations for All 8 Libraries

            This issue has been approved! Please generate implementations for **${{ steps.extract_spec.outputs.spec_id }}**.

            ### Instructions

            1. **Read the specification**
               - File: `specs/${{ steps.extract_spec.outputs.spec_id }}.md`
               - If file doesn't exist, create it from the issue body

            2. **Read generation rules**
               - `rules/generation/v1.0.0-draft/code-generation-rules.md`
               - `rules/generation/v1.0.0-draft/quality-criteria.md`
               - `rules/generation/v1.0.0-draft/self-review-checklist.md`

            3. **Generate implementations for all 8 libraries** (in order of priority):

               **3.1 matplotlib**
               - Determine the correct plot type folder from spec (e.g., histogram, scatter, bar, line, etc.)
               - Target: `plots/matplotlib/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Follow generation rules exactly
               - Implement all spec requirements
               - Use type hints, docstrings, validation
               - Add standalone execution block (`if __name__ == '__main__':`)
               - Self-review: Max 3 attempts to pass quality criteria

               **3.2 seaborn**
               - Determine the correct seaborn function folder (e.g., histplot, scatterplot, barplot, etc.)
               - Target: `plots/seaborn/{seaborn_function}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Same requirements as matplotlib

               **3.3 plotly**
               - Target: `plots/plotly/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Use plotly.express or plotly.graph_objects as appropriate
               - Ensure interactive features work

               **3.4 bokeh**
               - Target: `plots/bokeh/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Use bokeh.plotting interface
               - Include output_file() for standalone HTML generation

               **3.5 altair**
               - Target: `plots/altair/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Use declarative Vega-Lite approach
               - Leverage altair's data transformations where appropriate

               **3.6 plotnine**
               - Target: `plots/plotnine/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Use ggplot2-style grammar of graphics
               - Follow plotnine idioms (aes, geom_*, etc.)

               **3.7 pygal**
               - Target: `plots/pygal/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Generate SVG output
               - Use pygal's chart classes

               **3.8 highcharts**
               - Target: `plots/highcharts/{plot_type}/${{ steps.extract_spec.outputs.spec_id }}/default.py`
               - Use highcharts-core library (from highcharts_core import Chart)
               - Generate interactive HTML output
               - Note: Requires license for commercial use

            4. **Create Pull Request**
               - Branch: `auto/${{ steps.extract_spec.outputs.spec_id }}`
               - Title: `feat: implement ${{ steps.extract_spec.outputs.spec_id }}`
               - Include summary of generation results for ALL libraries
               - Link to this issue (#${{ github.event.issue.number }})

            ### Requirements
            - Each implementation must pass self-review before moving to next
            - Use deterministic sample data (fixed seeds or hardcoded data)
            - Code must work standalone (no external files)
            - Follow Python 3.10+ syntax
            - Commit with clear messages
            - If a library doesn't support the plot type well, note this in the PR but still try to create a reasonable approximation

            ### Expected Outcome
            - PR created with implementations for all 8 libraries
            - All pass self-review (score â‰¥ 85)
            - Tests will run automatically on PR

            Please proceed with the generation!
