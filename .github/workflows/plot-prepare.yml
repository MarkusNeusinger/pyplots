name: "Plot: Prepare"
run-name: "Prepare: ${{ github.event.issue.title }}"

# Unified workflow for NEW and UPDATE requests
# Phase 1: Validate, assign spec-id, create branch, generate spec
# STOPS after spec creation - waits for `approved` label before code generation
#
# Triggers:
# - plot-request label added â†’ NEW request flow
# - plot-request + update labels â†’ UPDATE request flow

on:
  issues:
    types: [labeled]

concurrency:
  group: plot-prepare-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  prepare:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      id-token: write

    outputs:
      spec_id: ${{ steps.process.outputs.spec_id }}
      feature_branch: ${{ steps.process.outputs.feature_branch }}
      is_update: ${{ steps.check.outputs.is_update }}

    steps:
      # ========================================================================
      # Step 1: Check conditions
      # ========================================================================
      - name: Check conditions
        id: check
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          LABEL_NAME: ${{ github.event.label.name }}
        run: |
          echo "=== Debug Info ==="
          echo "Event: ${{ github.event_name }}"
          echo "Label added: $LABEL_NAME"
          echo "Issue labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"
          echo "Issue title: $ISSUE_TITLE"
          echo "=================="

          # Only trigger when plot-request label is added
          if [[ "$LABEL_NAME" != "plot-request" ]]; then
            echo "::notice::Skipping: Not the 'plot-request' label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if this is an update request
          HAS_UPDATE="${{ contains(github.event.issue.labels.*.name, 'update') }}"
          if [[ "$HAS_UPDATE" == "true" ]]; then
            echo "is_update=true" >> $GITHUB_OUTPUT
            echo "::notice::This is an UPDATE request"
          else
            echo "is_update=false" >> $GITHUB_OUTPUT
            echo "::notice::This is a NEW request"
          fi

          # Skip if already has spec-id in title (already processed)
          if [[ "$ISSUE_TITLE" =~ ^\[[a-z0-9-]+\] ]]; then
            EXISTING_ID=$(echo "$ISSUE_TITLE" | grep -oP '^\[\K[a-z0-9-]+(?=\])' || echo "")
            # For updates, having spec-id is expected - continue
            if [[ "$HAS_UPDATE" == "true" ]]; then
              echo "::notice::Update request with existing spec ID: $EXISTING_ID"
            else
              echo "::notice::Skipping: Issue already has spec ID: $EXISTING_ID"
              echo "should_run=false" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: React with eyes emoji
        if: steps.check.outputs.should_run == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=eyes

      # ========================================================================
      # Step 2: Process request (NEW or UPDATE)
      # ========================================================================
      - name: Process with Claude
        if: steps.check.outputs.should_run == 'true'
        id: process
        timeout-minutes: 30
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--model opus"
          prompt: |
            ## Task: Prepare Plot Request

            You are processing a plot request. Determine if this is a NEW or UPDATE request and handle accordingly.

            ### Issue Details
            - **Title:** ${{ github.event.issue.title }}
            - **Number:** #${{ github.event.issue.number }}
            - **Is Update:** ${{ steps.check.outputs.is_update }}
            - **Body:**
            ```
            ${{ github.event.issue.body }}
            ```

            ---

            ## Instructions

            ### For NEW Requests (is_update=false):

            1. **Read the rules:** `prompts/spec-id-generator.md`

            2. **Check for duplicates:**
               - List all existing specs: `ls plots/`
               - Read existing spec files if titles seem similar
               - If duplicate found: Post comment explaining which spec matches, then STOP

            3. **Generate spec-id:**
               - Format: `{type}-{variant}` or `{type}-{variant}-{modifier}`
               - Examples: `scatter-basic`, `bar-grouped-horizontal`, `heatmap-correlation`
               - All lowercase, hyphens only

            4. **Create feature branch:**
               ```bash
               git checkout -b "plot/{spec-id}"
               ```

            5. **Create spec files:**
               - Read template: `prompts/templates/spec.md`
               - Read metadata template: `prompts/templates/metadata.yaml`
               - Create directory: `plots/{spec-id}/`
               - Create: `plots/{spec-id}/spec.md` (follow template structure)
               - Create: `plots/{spec-id}/metadata.yaml` (replace placeholders)
               - Create empty folder: `plots/{spec-id}/implementations/`

            6. **Commit and push:**
               ```bash
               git config user.name "github-actions[bot]"
               git config user.email "github-actions[bot]@users.noreply.github.com"
               git add plots/{spec-id}/
               git commit -m "spec: add {spec-id} specification

               Created from issue #${{ github.event.issue.number }}"
               git push -u origin "plot/{spec-id}"
               ```

            7. **Update issue title:**
               ```bash
               gh issue edit ${{ github.event.issue.number }} --title "[{spec-id}] {original title without 'Plot: ' prefix}"
               ```

            8. **Post comment with spec content:**
               Use this format (read the actual spec.md content you created):
               ```bash
               gh issue comment ${{ github.event.issue.number }} --body "## âœ… Spec Ready: \`{spec-id}\`

               **Branch:** \`plot/{spec-id}\`

               ---

               ### spec.md

               {paste full content of spec.md here}

               ---

               **Next:** Add \`approved\` label to start code generation.

               ---
               :robot: *[plot-prepare workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
               ```

            9. **Output for workflow:**
               After completing, print these lines exactly:
               ```
               SPEC_ID={spec-id}
               FEATURE_BRANCH=plot/{spec-id}
               ```

            ---

            ### For UPDATE Requests (is_update=true):

            1. **Extract spec-id from title:**
               - Title format: `[spec-id] [update] ...` or `[spec-id] [update:library] ...`
               - Extract the first bracket content as spec-id

            2. **Validate spec exists:**
               - Check if `plots/{spec-id}/spec.md` exists
               - If not: Post error comment and STOP

            3. **Extract target library (if specified):**
               - `[update:seaborn]` â†’ target only seaborn
               - `[update]` â†’ target all libraries

            4. **Analyze the update request:**
               - Read the current spec: `plots/{spec-id}/spec.md`
               - Read existing implementations if relevant
               - Evaluate if the update reason is sensible:
                 - Is this a valid improvement?
                 - Does it make sense for this plot type?
                 - Are there any concerns?

            5. **Create feature branch:**
               ```bash
               git checkout -b "plot/{spec-id}"
               git push -u origin "plot/{spec-id}"
               ```

            6. **Post comment with analysis:**
               ```bash
               gh issue comment ${{ github.event.issue.number }} --body "## ðŸ”„ Update Request: \`{spec-id}\`

               **Branch:** \`plot/{spec-id}\`
               **Scope:** {library name or 'all 9 libraries'}

               ---

               ### Analysis

               {Your assessment of the update request:
               - Is the reason valid? Why/why not?
               - What changes would this involve?
               - Any concerns or suggestions?}

               ---

               ### Current Spec

               \`\`\`markdown
               {paste current spec.md content}
               \`\`\`

               ---

               **Recommendation:** {Approve / Needs clarification / Not recommended}

               **Next:** Add \`approved\` label to start regeneration.

               ---
               :robot: *[plot-prepare workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"
               ```

            7. **Output for workflow:**
               ```
               SPEC_ID={spec-id}
               FEATURE_BRANCH=plot/{spec-id}
               ```

            ---

            ## Important Rules
            - Do NOT trigger any other workflows
            - Do NOT add labels
            - Do NOT close the issue
            - STOP after posting the comment - the `approved` label triggers the next phase

      # ========================================================================
      # Step 3: Parse outputs
      # ========================================================================
      - name: Parse Claude outputs
        if: steps.check.outputs.should_run == 'true'
        id: parse
        run: |
          # Claude should have printed SPEC_ID and FEATURE_BRANCH
          # These are captured in the action output
          echo "::notice::Prepare phase complete - waiting for 'approved' label"

      - name: Add rocket reaction on success
        if: steps.check.outputs.should_run == 'true' && success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=rocket
