name: "Gen: New Plot"
run-name: "Generate: ${{ github.event.issue.title }}"

on:
  issues:
    types: [labeled]

concurrency:
  group: spec-to-code-${{ github.event.issue.number }}
  cancel-in-progress: true

env:
  LIBRARIES: "matplotlib seaborn plotly bokeh altair plotnine pygal highcharts"

jobs:
  # ============================================================================
  # Step 1: Check conditions and extract spec ID
  # ============================================================================
  check-conditions:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      spec_id: ${{ steps.extract_spec.outputs.spec_id }}
      is_update: ${{ steps.extract_spec.outputs.is_update }}
      target_library: ${{ steps.extract_spec.outputs.target_library }}

    steps:
      - name: Check conditions
        id: check
        run: |
          echo "=== Debug Info ==="
          echo "Label added: ${{ github.event.label.name }}"
          echo "Issue labels: ${{ join(github.event.issue.labels.*.name, ', ') }}"
          echo "=================="

          # Check 1: Must be "approved" label being added
          if [[ "${{ github.event.label.name }}" != "approved" ]]; then
            echo "::notice::Skipping: Not the 'approved' label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check 2: Issue must have "plot-request" label
          HAS_PLOT_REQUEST="${{ contains(github.event.issue.labels.*.name, 'plot-request') }}"
          if [[ "$HAS_PLOT_REQUEST" != "true" ]]; then
            echo "::notice::Skipping: Issue does not have 'plot-request' label"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "::notice::All conditions met - proceeding with code generation"
          echo "should_run=true" >> $GITHUB_OUTPUT

      - name: Checkout repository
        if: steps.check.outputs.should_run == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract spec ID from issue
        if: steps.check.outputs.should_run == 'true'
        id: extract_spec
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          # Check for [update] or [update:library] prefix in title
          IS_UPDATE="false"
          TARGET_LIBRARY=""

          if echo "$ISSUE_TITLE" | grep -qiP '^\[update(:[a-z]+)?\]'; then
            IS_UPDATE="true"
            # Extract target library if specified (e.g., [update:seaborn])
            TARGET_LIBRARY=$(echo "$ISSUE_TITLE" | grep -oiP '^\[update:\K[a-z]+(?=\])' | tr '[:upper:]' '[:lower:]' || echo "")
            # Remove [update...] prefix from title for spec ID extraction
            CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[update[^]]*\]\s*//')
            echo "::notice::Update mode detected. Target library: ${TARGET_LIBRARY:-all}"
          else
            CLEAN_TITLE="$ISSUE_TITLE"
          fi

          # Check if issue was marked as duplicate
          COMMENTS=$(gh issue view ${{ github.event.issue.number }} --json comments -q '.comments[].body')

          if echo "$COMMENTS" | grep -q "Duplicate Detected"; then
            echo "::error::This issue was marked as a duplicate"
            exit 1
          fi

          # For updates, try to extract spec ID from cleaned title first
          if [ "$IS_UPDATE" == "true" ]; then
            SPEC_ID=$(echo "$CLEAN_TITLE" | grep -oiP '^[a-z]+-[a-z]+(-[a-z0-9]+)?' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          # Extract spec ID from issue comments (assigned by validate-plot-request workflow)
          if [ -z "$SPEC_ID" ]; then
            SPEC_ID=$(echo "$COMMENTS" | grep -oP '\*\*Assigned ID:\*\* `\K[a-z0-9-]+(?=`)' | tail -1 || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            SPEC_ID=$(echo "$COMMENTS" | grep -oP '\*\*Existing Spec:\*\* `\K[a-z0-9-]+(?=`)' | tail -1 || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oiP '^[a-z]+-[a-z]+(-[a-z0-9]+)?' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            SPEC_ID=$(echo "$ISSUE_TITLE" | grep -oiP '^[a-z]+-[a-z]+-\d{3,4}' | tr '[:upper:]' '[:lower:]' || echo "")
          fi

          if [ -z "$SPEC_ID" ]; then
            echo "::error::Could not extract spec ID from issue"
            exit 1
          fi

          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "is_update=$IS_UPDATE" >> $GITHUB_OUTPUT
          echo "target_library=$TARGET_LIBRARY" >> $GITHUB_OUTPUT
          echo "::notice::Extracted spec ID: $SPEC_ID (update=$IS_UPDATE, target=$TARGET_LIBRARY)"

  # ============================================================================
  # Step 2: Create sub-issues for each library
  # ============================================================================
  create-sub-issues:
    needs: check-conditions
    if: needs.check-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    outputs:
      matplotlib_issue: ${{ steps.create.outputs.matplotlib_issue }}
      seaborn_issue: ${{ steps.create.outputs.seaborn_issue }}
      plotly_issue: ${{ steps.create.outputs.plotly_issue }}
      bokeh_issue: ${{ steps.create.outputs.bokeh_issue }}
      altair_issue: ${{ steps.create.outputs.altair_issue }}
      plotnine_issue: ${{ steps.create.outputs.plotnine_issue }}
      pygal_issue: ${{ steps.create.outputs.pygal_issue }}
      highcharts_issue: ${{ steps.create.outputs.highcharts_issue }}
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: React with eyes emoji
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=eyes

      - name: Add in-progress label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --add-label "in-progress"

      - name: Create sub-issues for each library
        id: create
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SPEC_ID="${{ needs.check-conditions.outputs.spec_id }}"
          PARENT_NUM="${{ github.event.issue.number }}"
          PARENT_NODE_ID=$(gh api repos/${{ github.repository }}/issues/$PARENT_NUM --jq '.node_id')

          for LIBRARY in ${{ env.LIBRARIES }}; do
            echo "Creating sub-issue for $LIBRARY..."

            # Check if sub-issue already exists
            EXISTING=$(gh issue list --label "library:$LIBRARY" --search "[$SPEC_ID] in:title" --json number -q '.[0].number' 2>/dev/null || echo "")

            if [ -n "$EXISTING" ]; then
              echo "${LIBRARY}_issue=$EXISTING" >> $GITHUB_OUTPUT
              echo "::notice::Sub-issue for $LIBRARY already exists: #$EXISTING"
              continue
            fi

            # Create sub-issue
            SUB_BODY="## [$SPEC_ID] $LIBRARY Implementation

          **Parent Issue:** #$PARENT_NUM
          **Spec:** \`specs/$SPEC_ID.md\`
          **Library:** $LIBRARY

          ---

          ### Attempt History

          _Attempts will be documented below as comments._
          "

            SUB_ISSUE=$(gh issue create \
              --title "[$SPEC_ID] $LIBRARY implementation" \
              --body "$SUB_BODY" \
              --label "library:$LIBRARY,plot-request:impl,generating")

            SUB_NUM=$(echo "$SUB_ISSUE" | grep -oP '\d+$')
            SUB_NODE_ID=$(gh api repos/${{ github.repository }}/issues/$SUB_NUM --jq '.node_id')

            # Link as sub-issue using GitHub's sub-issues API
            gh api graphql -f query='
              mutation($parent: ID!, $child: ID!) {
                addSubIssue(input: {issueId: $parent, subIssueId: $child}) {
                  issue { id }
                }
              }' -f parent="$PARENT_NODE_ID" -f child="$SUB_NODE_ID" 2>/dev/null || echo "Note: Sub-issue linking not available"

            echo "${LIBRARY}_issue=$SUB_NUM" >> $GITHUB_OUTPUT
            echo "::notice::Created sub-issue for $LIBRARY: #$SUB_NUM"
          done

  # ============================================================================
  # Step 3: Generate implementations in parallel (one job per library)
  # ============================================================================
  generate-matplotlib:
    needs: [check-conditions, create-sub-issues]
    if: |
      needs.check-conditions.outputs.should_run == 'true' &&
      (needs.check-conditions.outputs.target_library == '' ||
       needs.check-conditions.outputs.target_library == 'matplotlib')
    uses: ./.github/workflows/gen-library-impl.yml
    with:
      spec_id: ${{ needs.check-conditions.outputs.spec_id }}
      library: matplotlib
      main_issue_number: ${{ github.event.issue.number }}
      sub_issue_number: ${{ needs.create-sub-issues.outputs.matplotlib_issue }}
      deps: "matplotlib>=3.9.0 numpy>=1.26.0"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  generate-seaborn:
    needs: [check-conditions, create-sub-issues]
    if: |
      needs.check-conditions.outputs.should_run == 'true' &&
      (needs.check-conditions.outputs.target_library == '' ||
       needs.check-conditions.outputs.target_library == 'seaborn')
    uses: ./.github/workflows/gen-library-impl.yml
    with:
      spec_id: ${{ needs.check-conditions.outputs.spec_id }}
      library: seaborn
      main_issue_number: ${{ github.event.issue.number }}
      sub_issue_number: ${{ needs.create-sub-issues.outputs.seaborn_issue }}
      deps: "seaborn>=0.13.0 matplotlib numpy>=1.26.0"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  generate-plotly:
    needs: [check-conditions, create-sub-issues]
    if: |
      needs.check-conditions.outputs.should_run == 'true' &&
      (needs.check-conditions.outputs.target_library == '' ||
       needs.check-conditions.outputs.target_library == 'plotly')
    uses: ./.github/workflows/gen-library-impl.yml
    with:
      spec_id: ${{ needs.check-conditions.outputs.spec_id }}
      library: plotly
      main_issue_number: ${{ github.event.issue.number }}
      sub_issue_number: ${{ needs.create-sub-issues.outputs.plotly_issue }}
      deps: "plotly>=5.18.0 kaleido>=0.2.1 numpy>=1.26.0"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  generate-bokeh:
    needs: [check-conditions, create-sub-issues]
    if: |
      needs.check-conditions.outputs.should_run == 'true' &&
      (needs.check-conditions.outputs.target_library == '' ||
       needs.check-conditions.outputs.target_library == 'bokeh')
    uses: ./.github/workflows/gen-library-impl.yml
    with:
      spec_id: ${{ needs.check-conditions.outputs.spec_id }}
      library: bokeh
      main_issue_number: ${{ github.event.issue.number }}
      sub_issue_number: ${{ needs.create-sub-issues.outputs.bokeh_issue }}
      deps: "bokeh>=3.4.0 numpy>=1.26.0"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  generate-altair:
    needs: [check-conditions, create-sub-issues]
    if: |
      needs.check-conditions.outputs.should_run == 'true' &&
      (needs.check-conditions.outputs.target_library == '' ||
       needs.check-conditions.outputs.target_library == 'altair')
    uses: ./.github/workflows/gen-library-impl.yml
    with:
      spec_id: ${{ needs.check-conditions.outputs.spec_id }}
      library: altair
      main_issue_number: ${{ github.event.issue.number }}
      sub_issue_number: ${{ needs.create-sub-issues.outputs.altair_issue }}
      deps: "altair>=5.2.0 vl-convert-python>=1.3.0 numpy>=1.26.0"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  generate-plotnine:
    needs: [check-conditions, create-sub-issues]
    if: |
      needs.check-conditions.outputs.should_run == 'true' &&
      (needs.check-conditions.outputs.target_library == '' ||
       needs.check-conditions.outputs.target_library == 'plotnine')
    uses: ./.github/workflows/gen-library-impl.yml
    with:
      spec_id: ${{ needs.check-conditions.outputs.spec_id }}
      library: plotnine
      main_issue_number: ${{ github.event.issue.number }}
      sub_issue_number: ${{ needs.create-sub-issues.outputs.plotnine_issue }}
      deps: "plotnine>=0.13.0 numpy>=1.26.0"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  generate-pygal:
    needs: [check-conditions, create-sub-issues]
    if: |
      needs.check-conditions.outputs.should_run == 'true' &&
      (needs.check-conditions.outputs.target_library == '' ||
       needs.check-conditions.outputs.target_library == 'pygal')
    uses: ./.github/workflows/gen-library-impl.yml
    with:
      spec_id: ${{ needs.check-conditions.outputs.spec_id }}
      library: pygal
      main_issue_number: ${{ github.event.issue.number }}
      sub_issue_number: ${{ needs.create-sub-issues.outputs.pygal_issue }}
      deps: "pygal>=3.0.0 cairosvg>=2.7.0"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  generate-highcharts:
    needs: [check-conditions, create-sub-issues]
    if: |
      needs.check-conditions.outputs.should_run == 'true' &&
      (needs.check-conditions.outputs.target_library == '' ||
       needs.check-conditions.outputs.target_library == 'highcharts')
    uses: ./.github/workflows/gen-library-impl.yml
    with:
      spec_id: ${{ needs.check-conditions.outputs.spec_id }}
      library: highcharts
      main_issue_number: ${{ github.event.issue.number }}
      sub_issue_number: ${{ needs.create-sub-issues.outputs.highcharts_issue }}
      deps: "highcharts-core>=1.10.0 numpy>=1.26.0"
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

  # ============================================================================
  # Step 4: Summary after all generations complete
  # ============================================================================
  summary:
    needs:
      - check-conditions
      - create-sub-issues
      - generate-matplotlib
      - generate-seaborn
      - generate-plotly
      - generate-bokeh
      - generate-altair
      - generate-plotnine
      - generate-pygal
      - generate-highcharts
    if: always() && needs.check-conditions.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check if summary already posted
        id: check_summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if "Generation Complete" comment already exists (idempotency)
          EXISTING=$(gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '[.[] | select(.body | startswith("## Generation Complete"))] | length')

          if [ "$EXISTING" -gt "0" ]; then
            echo "Summary already posted, skipping"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Post summary to main issue
        if: steps.check_summary.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SPEC_ID="${{ needs.check-conditions.outputs.spec_id }}"

          # Post summary comment
          gh issue comment ${{ github.event.issue.number }} --body "## Generation Complete

          All 8 library generation jobs have been dispatched for \`$SPEC_ID\`.

          ### Sub-Issues Created
          - matplotlib: #${{ needs.create-sub-issues.outputs.matplotlib_issue }}
          - seaborn: #${{ needs.create-sub-issues.outputs.seaborn_issue }}
          - plotly: #${{ needs.create-sub-issues.outputs.plotly_issue }}
          - bokeh: #${{ needs.create-sub-issues.outputs.bokeh_issue }}
          - altair: #${{ needs.create-sub-issues.outputs.altair_issue }}
          - plotnine: #${{ needs.create-sub-issues.outputs.plotnine_issue }}
          - pygal: #${{ needs.create-sub-issues.outputs.pygal_issue }}
          - highcharts: #${{ needs.create-sub-issues.outputs.highcharts_issue }}

          ### Next Steps
          Each library will:
          1. Generate implementation code
          2. Create a separate PR
          3. Run tests
          4. Generate preview images
          5. Undergo AI quality review
          6. Auto-merge if quality score >= 85

          Check the **Implementation Status** table above for real-time progress.

          ---
          :robot: *[gen-new-plot workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*"

      - name: Remove in-progress label
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue edit ${{ github.event.issue.number }} --remove-label "in-progress" || true
