name: Validate Plot Request

on:
  issues:
    types: [opened, edited]

concurrency:
  group: validate-plot-request-${{ github.event.issue.number }}
  cancel-in-progress: false

jobs:
  validate-and-assign-id:
    # Only run for issues with "plot-request" label AND no spec ID in title yet
    # Spec ID format: [some-spec-id] at end of title
    if: |
      contains(github.event.issue.labels.*.name, 'plot-request') &&
      !contains(github.event.issue.title, '[')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: React with eyes emoji
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/reactions \
            -f content=eyes

      - name: Run Claude Code to validate and assign spec ID
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: "--model opus"
          prompt: |
            ## üîç Task: Validate Plot Request and Assign Spec ID

            A new plot request has been submitted. Your job is to:
            1. Analyze the request
            2. Check for duplicates/similar specs
            3. Assign a meaningful spec ID (or flag as duplicate)

            ### Issue Details
            - **Title:** ${{ github.event.issue.title }}
            - **Number:** #${{ github.event.issue.number }}

            ### Issue Body:
            ```
            ${{ github.event.issue.body }}
            ```

            ### Instructions

            #### Step 1: Read all existing specs
            - List all files in `specs/` directory (excluding .template.md and VERSIONING.md)
            - Read each spec file to understand what plots already exist
            - Pay attention to: Description, Tags, Use Cases

            #### Step 2: Analyze the request
            - What type of plot is being requested? (scatter, bar, line, heatmap, etc.)
            - What variant/feature is being requested? (basic, grouped, stacked, 3d, etc.)
            - What makes it unique? (regression, animation, interactive, etc.)

            #### Step 3: Check for duplicates
            Compare the request against existing specs:
            - **Exact duplicate**: Same plot type AND same features ‚Üí Flag as duplicate
            - **Very similar** (>80% overlap): Same type, minor differences ‚Üí Suggest existing spec
            - **Related but different**: Same type, different features ‚Üí New spec OK
            - **Completely new**: New plot type ‚Üí New spec OK

            #### Step 4: Generate spec ID (if not duplicate)

            **ID Format:** `{plot-type}-{variant}-{modifier}` (all lowercase, hyphens only)

            **Rules:**
            - `plot-type`: The main visualization type (scatter, bar, line, heatmap, histogram, box, violin, pie, area, radar, etc.)
            - `variant`: The main characteristic (basic, grouped, stacked, horizontal, 3d, multi, etc.)
            - `modifier`: Optional - additional feature (regression, animated, interactive, annotated, etc.)

            **Examples:**
            - Basic scatter plot ‚Üí `scatter-basic`
            - Scatter with color mapping ‚Üí `scatter-color-mapped`
            - Scatter with linear regression ‚Üí `scatter-regression-linear`
            - 3D scatter with rotation ‚Üí `scatter-3d-interactive`
            - Grouped bar chart ‚Üí `bar-grouped`
            - Horizontal stacked bar ‚Üí `bar-stacked-horizontal`
            - Correlation heatmap ‚Üí `heatmap-correlation`
            - Annotated heatmap ‚Üí `heatmap-annotated`
            - Multi-line time series ‚Üí `line-timeseries-multi`
            - Box plot with outliers ‚Üí `box-outliers-highlighted`

            **ID must be:**
            - Unique (not already used)
            - Descriptive (someone can guess what it does)
            - Concise (2-3 parts, max 40 characters)
            - Lowercase with hyphens only

            #### Step 5: Post comment with result

            Use `gh issue comment` to post ONE of these responses:

            **If DUPLICATE:**
            ```markdown
            ## üîÑ Duplicate Detected

            This plot request appears to be a duplicate of an existing spec:

            **Existing Spec:** `{existing-spec-id}`
            **File:** `specs/{existing-spec-id}.md`

            **Similarity:** {brief explanation of why it's a duplicate}

            Please review the existing spec. If you believe this is different, please update the issue with more details about what makes it unique.

            ---
            ü§ñ *Generated by [validate-plot-request workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            ```

            **If SIMILAR (suggest existing):**
            ```markdown
            ## ‚ö†Ô∏è Similar Spec Exists

            This request is very similar to an existing spec:

            **Existing Spec:** `{existing-spec-id}`
            **File:** `specs/{existing-spec-id}.md`

            **Differences:** {brief explanation}

            **Options:**
            1. Use the existing spec if it meets your needs
            2. Update this issue to clarify the unique requirements
            3. Consider this a variant of the existing spec

            ---
            ü§ñ *Generated by [validate-plot-request workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            ```

            **If NEW (assign ID):**
            ```markdown
            ## ‚úÖ Spec ID Assigned

            **Assigned ID:** `{new-spec-id}`

            **Rationale:** {1-2 sentences explaining why this ID was chosen}

            **Next Steps:**
            1. A maintainer will review this request
            2. Once approved (label: `approved`), code generation will begin automatically
            3. Implementations will be created for matplotlib and seaborn

            **Spec will be created at:** `specs/{new-spec-id}.md`

            ---
            ü§ñ *Generated by [validate-plot-request workflow](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})*
            ```

            #### Step 6: Update issue title with spec ID (if NEW)

            After posting the comment, update the issue title to include the spec ID in brackets:
            - Use: `gh issue edit ${{ github.event.issue.number }} --title "ORIGINAL_TITLE [{new-spec-id}]"`
            - Example: "Plot: Basic bar chart" ‚Üí "Plot: Basic bar chart [bar-basic]"
            - This makes issues searchable by spec ID

            ### Important Notes
            - Do NOT create any files - only analyze and comment
            - Do NOT add or remove labels
            - Use `gh issue comment ${{ github.event.issue.number }} --body "..."` to post comment
            - Use `gh issue edit ${{ github.event.issue.number }} --title "..."` to update title (only for NEW specs)
            - Be helpful and constructive in feedback
            - If the request is unclear, ask for clarification in the comment