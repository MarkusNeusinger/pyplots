name: "Bot: AI Review"

on:
  workflow_run:
    workflows: ["Generate Plot Previews"]
    types: [completed]

jobs:
  ai-review:
    # Only run when preview generation was successful
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download plot metadata
        uses: actions/download-artifact@v4
        with:
          name: plot-metadata
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load metadata
        id: metadata
        run: |
          if [ ! -f plot_metadata.json ]; then
            echo "No plot metadata found, skipping AI review"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          PR_NUMBER=$(jq -r '.pr_number' plot_metadata.json)
          ISSUE_NUMBER=$(jq -r '.issue_number' plot_metadata.json)
          TIMESTAMP=$(jq -r '.timestamp' plot_metadata.json)
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Get PR details
        if: steps.metadata.outputs.skip != 'true'
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_DATA=$(gh pr view ${{ steps.metadata.outputs.pr_number }} --json headRefName,number)
          HEAD_REF=$(echo "$PR_DATA" | jq -r '.headRefName')

          # Check if auto/ branch
          if [[ ! "$HEAD_REF" =~ ^auto/ ]]; then
            echo "Not an auto/ branch, skipping AI review"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract spec-id from branch name (auto/scatter-basic-005)
          SPEC_ID=$(echo "$HEAD_REF" | sed 's|auto/||')
          echo "spec_id=$SPEC_ID" >> $GITHUB_OUTPUT
          echo "skip=false" >> $GITHUB_OUTPUT
          echo "Spec ID: $SPEC_ID"

      - name: Setup Google Cloud authentication
        if: steps.pr.outputs.skip != 'true'
        id: gcs_auth
        continue-on-error: true
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCS_CREDENTIALS }}

      - name: Setup gcloud CLI
        if: steps.pr.outputs.skip != 'true' && steps.gcs_auth.outcome == 'success'
        uses: google-github-actions/setup-gcloud@v2

      - name: Download plot images
        if: steps.pr.outputs.skip != 'true' && steps.gcs_auth.outcome == 'success'
        run: |
          SPEC_ID="${{ steps.pr.outputs.spec_id }}"
          TIMESTAMP="${{ steps.metadata.outputs.timestamp }}"

          mkdir -p plot_images

          # Download plot images for this spec from all libraries
          gsutil -m cp -r "gs://${{ secrets.GCS_BUCKET }}/plots/${SPEC_ID}/**/*v${TIMESTAMP}*.png" plot_images/ 2>/dev/null || echo "No plot images found"

          # List downloaded images
          echo "ğŸ“Š Downloaded plot images:"
          find plot_images -name "*.png" -type f 2>/dev/null || echo "No images found"

      - name: Check attempt count
        if: steps.pr.outputs.skip != 'true'
        id: attempts
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          LABELS=$(gh pr view ${{ steps.metadata.outputs.pr_number }} --json labels -q '.labels[].name' 2>/dev/null || echo "")

          if echo "$LABELS" | grep -q "ai-attempt-3"; then
            echo "count=3" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "ai-attempt-2"; then
            echo "count=2" >> $GITHUB_OUTPUT
          elif echo "$LABELS" | grep -q "ai-attempt-1"; then
            echo "count=1" >> $GITHUB_OUTPUT
          else
            echo "count=0" >> $GITHUB_OUTPUT
          fi

      - name: React with eyes emoji
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count != '3'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api repos/${{ github.repository }}/issues/${{ steps.metadata.outputs.pr_number }}/reactions \
            -f content=eyes

      - name: Trigger Claude Quality Check
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count != '3'
        uses: actions/github-script@v7
        with:
          script: |
            const specId = '${{ steps.pr.outputs.spec_id }}';
            const attempt = parseInt('${{ steps.attempts.outputs.count }}') + 1;
            const prNumber = ${{ steps.metadata.outputs.pr_number }};
            const issueNumber = '${{ steps.metadata.outputs.issue_number }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `@claude

            ## ğŸ¯ Task: AI Quality Review (Attempt ${attempt}/3)

            Tests passed and preview images are ready. Evaluate if the implementation matches the specification.

            ### Your Task

            1. **Read the spec file**: \`specs/${specId}.md\`
               - Note all quality criteria listed
               - Understand the expected visual output

            2. **Read the implementation files**:
               - \`plots/matplotlib/*/${specId}/default.py\`
               - \`plots/seaborn/*/${specId}/default.py\`

            3. **View the plot images** in \`plot_images/\` directory
               - Use your vision capabilities to analyze each image
               - Compare with the spec requirements

            4. **Evaluate against spec requirements** and create a checklist

            5. **IMPORTANT: Post your verdict to Issue #${issueNumber}** (NOT the PR!) using this format:

            \`\`\`markdown
            ## ğŸ¤– AI Review (PR #${prNumber})

            ### Status: âœ… Approved / âŒ Rejected

            ### Evaluation
            | Criterion | Score |
            |-----------|-------|
            | Code Quality | X/10 |
            | Spec Conformity | X/10 |
            | Visual Quality | X/10 |

            ### Spec Requirements
            - [x] Requirement 1 from spec
            - [x] Requirement 2 from spec
            - [ ] Requirement 3 â† Issue here

            ### Improvement Suggestions (for future updates)
            - [ ] Suggestion 1 (even if approved, note areas for improvement)
            - [ ] Suggestion 2

            ### Critical Issues (only if rejected)
            - Issue 1 that must be fixed
            - Issue 2 that must be fixed
            \`\`\`

            6. **Take action based on result**:
               - **âœ… Approved** (score >= 7/10 on all criteria):
                 - Run: \`gh pr edit ${prNumber} --add-label ai-approved\`
                 - Post review to Issue #${issueNumber} (include suggestions for future updates)
               - **âŒ Rejected** (any score < 7/10):
                 - Run: \`gh pr edit ${prNumber} --add-label ai-rejected\`
                 - Post review to Issue #${issueNumber} (include specific fixes needed)

            **Remember:** The Issue is the permanent knowledge base. Include all feedback there, even if approved!`
            });

      - name: Mark as failed after 3 attempts
        if: steps.pr.outputs.skip != 'true' && steps.attempts.outputs.count == '3'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ISSUE_NUM="${{ steps.metadata.outputs.issue_number }}"
          PR_NUM="${{ steps.metadata.outputs.pr_number }}"

          gh pr edit "$PR_NUM" --add-label "ai-rejected"

          # Post to Issue
          gh issue comment "$ISSUE_NUM" --body "## ğŸ” Quality Check

          ### Status: âŒ Rejected

          AI Review failed after 3 attempts. Manual review required.

          **PR:** #$PR_NUM

          ---
          ğŸ¤– *Automated quality check*"

          # Post to PR
          gh pr comment "$PR_NUM" --body "âŒ AI Review failed after 3 attempts. Manual review required."
